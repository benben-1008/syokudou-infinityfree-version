<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£Ÿå ‚å°‚ç”¨AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .page-bg {
            position: relative;
            background-color: #f5f5f5;
        }

        .page-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('images/olive.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.2;
            z-index: 1;
            pointer-events: none;
        }

        .page-bg-image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.2;
            z-index: 1;
            pointer-events: none;
        }

        .page-bg > * {
            position: relative;
            z-index: 2;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.92);
        }

        .ai-settings {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .ai-settings h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .ai-settings label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-indicator.available {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-indicator.unavailable {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .debug-info {
            margin-top: 10px;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .debug-info.gemini {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
        }

        .debug-info.groq {
            background: linear-gradient(135deg, #00d4ff 0%, #090979 100%);
        }

        .debug-info.openai {
            background: linear-gradient(135deg, #10a37f 0%, #1a7f64 100%);
        }

        .debug-info.huggingface {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
        }

        .debug-info.ollama {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        }

        .debug-info-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .debug-info-detail {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .api-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.3);
            margin-left: 8px;
        }

        /* è¿½åŠ : ã‚¢ãƒã‚¿ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .message {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .message .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: #f0f0f0;
            flex-shrink: 0;
            border: 1px solid #e0e0e0;
        }

        .message .content {
            flex: 1;
        }

        .assistant-message .avatar {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }

        .user-message .avatar {
            background: #eef2f7;
            border-color: #d5deea;
        }

        /* ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« */
        .ai-hero {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #fff8e1;
            border: 1px solid #ffe0b2;
            font-size: 18px;
            margin-top: 6px;
        }
    </style>
</head>

<body class="page-bg">
    <div class="page-bg-image-overlay" id="bgImageOverlay"></div>
    <div class="container">
        <header>
            <h1>ğŸ½ï¸ é£Ÿå ‚å°‚ç”¨AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
            <p>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€å–¶æ¥­æ™‚é–“ã€äºˆç´„ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™</p>
            <div class="ai-hero" aria-label="AIãƒ†ãƒ¼ãƒ">
                <span>ğŸ¤–</span><span>ï¼‹</span><span>ğŸ½ï¸</span>
                <span style="color:#6c757d; font-size:14px;">AI Ã— é£Ÿå ‚</span>
            </div>
        </header>

        <div class="chat-container">
            <div id="chatMessages" class="chat-messages"></div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." maxlength="500">
                <button id="sendBtn">é€ä¿¡</button>
            </div>
        </div>

        <div class="quick-questions">
            <h3>ã‚ˆãã‚ã‚‹è³ªå•</h3>
            <div class="quick-buttons">
                <button class="quick-btn" data-question="ä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ä½•ã§ã™ã‹ï¼Ÿ">ä»Šæ—¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
                <button class="quick-btn" data-question="å–¶æ¥­æ™‚é–“ã‚’æ•™ãˆã¦ãã ã•ã„">å–¶æ¥­æ™‚é–“</button>
                <button class="quick-btn" data-question="äºˆç´„ã¯ã§ãã¾ã™ã‹ï¼Ÿ">äºˆç´„ã«ã¤ã„ã¦</button>
                <button class="quick-btn" data-question="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ">ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œ</button>
                <button class="quick-btn" data-question="æ–™é‡‘ã‚’æ•™ãˆã¦ãã ã•ã„">æ–™é‡‘</button>
                <button class="quick-btn" data-question="å ´æ‰€ã‚’æ•™ãˆã¦ãã ã•ã„">å ´æ‰€</button>
            </div>

            <div class="ai-settings">
                <h4>AIè¨­å®š</h4>
                <label>
                    <input type="checkbox" id="useOllama" checked> AI APIã‚’ä½¿ç”¨ã™ã‚‹
                </label>
                <div id="ollamaStatus" class="status-indicator">ğŸ”„ ãƒã‚§ãƒƒã‚¯ä¸­...</div>
            </div>
        </div>

        <section class="info-section">
            <h2>ğŸ“Š é‹å–¶æƒ…å ±</h2>
            <div id="ops-info" class="info-card"></div>
        </section>

        <div class="back-link">
            <a href="index.html">â† ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <script>
        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
        let chatHistory = [];

        // æœ¬ç•ªç’°å¢ƒã‹ã©ã†ã‹ã‚’åˆ¤å®š
        function isProductionEnvironment() {
            const host = window.location.hostname;
            const isLocalhost = host === 'localhost' ||
                host === '127.0.0.1' ||
                host === '::1' ||
                host.includes('localhost');
            return !isLocalhost;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            console.log('AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆPHPç‰ˆï¼‰ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            
            // èƒŒæ™¯ç”»åƒã‚’è¨­å®šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼‰
            const bgOverlay = document.getElementById('bgImageOverlay');
            if (bgOverlay) {
                const timestamp = new Date().getTime();
                bgOverlay.style.backgroundImage = `url('images/olive.jpg?v=${timestamp}')`;
                console.log('èƒŒæ™¯ç”»åƒã‚’è¨­å®šã—ã¾ã—ãŸ:', `images/olive.jpg?v=${timestamp}`);
            }

            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessageToChat('assistant', 'ã“ã‚“ã«ã¡ã¯ï¼é£Ÿå ‚ã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚\n\nä½•ã‹ãŠæ‰‹ä¼ã„ã§ãã‚‹ã“ã¨ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå£°ã‹ã‘ãã ã•ã„ã€‚');

            // Ollamaã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            checkOllamaStatus();

            // é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const sendBtn = document.getElementById('sendBtn');
            console.log('é€ä¿¡ãƒœã‚¿ãƒ³è¦ç´ :', sendBtn);
            if (sendBtn) {
                sendBtn.addEventListener('click', function () {
                    console.log('é€ä¿¡ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                    sendMessage();
                });
                console.log('é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
            } else {
                console.error('é€ä¿¡ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®Enterã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
            const chatInput = document.getElementById('chatInput');
            console.log('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¦ç´ :', chatInput);
            if (chatInput) {
                chatInput.addEventListener('keypress', function (e) {
                    console.log('ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ:', e.key);
                    if (e.key === 'Enter') {
                        console.log('Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                        sendMessage();
                    }
                });
                console.log('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
            } else {
                console.error('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // ã‚¯ã‚¤ãƒƒã‚¯è³ªå•ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const quickButtons = document.querySelectorAll('.quick-btn');
            console.log('ã‚¯ã‚¤ãƒƒã‚¯è³ªå•ãƒœã‚¿ãƒ³ã®æ•°:', quickButtons.length);
            quickButtons.forEach((button, index) => {
                console.log(`ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³${index + 1}:`, button);
                button.addEventListener('click', function () {
                    console.log('ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', this.textContent);
                    const question = this.getAttribute('data-question');
                    console.log('è³ªå•å†…å®¹:', question);
                    document.getElementById('chatInput').value = question;
                    sendMessage();
                });
            });

            // é‹å–¶æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            loadOpsInfo();
        });

        // Ollamaã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        async function checkOllamaStatus() {
            try {
                console.log('OllamaçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...');

                const response = await fetch('api/ai-response.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'test',
                        useOllama: false
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const statusElement = document.getElementById('ollamaStatus');

                    console.log('OllamaçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯çµæœ:', data);

                    if (data.ollamaAvailable) {
                        statusElement.innerHTML = 'âœ… AI API åˆ©ç”¨å¯èƒ½ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼‰';
                        statusElement.className = 'status-indicator available';
                        console.log('AI API ãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ï¼‰');
                    } else {
                        statusElement.innerHTML = 'âŒ AI API åˆ©ç”¨ä¸å¯ï¼ˆåŸºæœ¬å¿œç­”ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ï¼‰';
                        statusElement.className = 'status-indicator unavailable';
                        document.getElementById('useOllama').checked = false;
                        console.log('AI API ãŒåˆ©ç”¨ä¸å¯ã§ã™');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('OllamaçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                const statusElement = document.getElementById('ollamaStatus');
                statusElement.innerHTML = 'âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆåŸºæœ¬å¿œç­”ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ï¼‰';
                statusElement.className = 'status-indicator unavailable';
                document.getElementById('useOllama').checked = false;
            }
        }

        // é‹å–¶æƒ…å ±ï¼ˆå®šé£Ÿãƒ»ä¼‘æ¥­æ—¥ãƒ»äºˆç´„æ™‚é–“ãƒ»äºˆç´„äººæ•°/æ··é›‘äºˆæ¸¬ï¼‰
        async function loadOpsInfo() {
            const opsDiv = document.getElementById('ops-info');
            if (!opsDiv) return;

            const API_BASE = 'api/';
            async function apiGet(path) {
                const res = await fetch(API_BASE + path, { cache: 'no-store' });
                if (!res.ok) throw new Error('GET failed: ' + path);
                return await res.json();
            }

            try {
                const [holidays, dailyMenus, reservationTimes, reservations] = await Promise.all([
                    apiGet('holidays.php'),
                    apiGet('daily-menu.php'),
                    apiGet('reservation-times.php'),
                    apiGet('reservations.php')
                ]);

                const today = new Date().toISOString().split('T')[0];
                const todayMenu = (dailyMenus || []).find(m => m.date === today);
                const todayHoliday = (holidays || []).find(h => h.date === today);

                // äºˆç´„äººæ•°ï¼ˆæœ¬æ—¥ï¼‰
                const todaysReservations = (reservations || []).filter(r => (r.createdAt || '').startsWith(today));
                const reservationCount = todaysReservations.length;

                // æ··é›‘äºˆæ¸¬ï¼ˆå˜ç´”ãªãƒ«ãƒ¼ãƒ«ï¼‰
                let congestion = 'ç©ºã„ã¦ã„ã¾ã™';
                if (reservationCount >= 30) congestion = 'éå¸¸ã«æ··é›‘';
                else if (reservationCount >= 15) congestion = 'ã‚„ã‚„æ··é›‘';

                // äºˆç´„æ™‚é–“è¡¨ç¤º
                let timeHtml = '';
                if (reservationTimes && reservationTimes.enabled) {
                    timeHtml = `â° äºˆç´„æ™‚é–“: ${reservationTimes.startTime} - ${reservationTimes.endTime}<br>`;
                } else {
                    timeHtml = 'â° äºˆç´„æ™‚é–“: åˆ¶é™ãªã—ï¼ˆã„ã¤ã§ã‚‚äºˆç´„å¯èƒ½ï¼‰<br>';
                }

                opsDiv.innerHTML = `
                    <div style="line-height:1.8;">
                        <p><strong>ğŸ“… æœ¬æ—¥ã®å–¶æ¥­çŠ¶æ³:</strong> ${todayHoliday ? `ğŸš« ä¼‘æ¥­ï¼ˆç†ç”±: ${todayHoliday.reason}ï¼‰` : 'âœ… å–¶æ¥­äºˆå®š'}</p>
                        <p><strong>ğŸ½ï¸ æœ¬æ—¥ã®å®šé£Ÿ:</strong> ${todayMenu ? todayMenu.food : 'æœªè¨­å®š'}</p>
                        <p>${timeHtml}<strong>ğŸ‘¥ æœ¬æ—¥ã®äºˆç´„äººæ•°:</strong> ${reservationCount}äºº<br>
                        <strong>ğŸ“ˆ æ··é›‘äºˆæ¸¬:</strong> ${congestion}</p>
                    </div>
                `;
            } catch (e) {
                console.error('é‹å–¶æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
                opsDiv.innerHTML = '<p style="color:#dc3545;">é‹å–¶æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ 
        function addMessageToChat(sender, message, debugInfo = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;

            const senderName = sender === 'user' ? 'ã‚ãªãŸ' : 'AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ';
            const avatarEmoji = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–ğŸ½ï¸';
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã‚ã‚‹å ´åˆã€AIåã‚’è¡¨ç¤º
            let apiNameDisplay = '';
            if (debugInfo && debugInfo.usedApi) {
                const apiNames = {
                    'gemini': 'ğŸ¤– Gemini',
                    'groq': 'âš¡ Groq',
                    'openai': 'ğŸ§  OpenAI',
                    'huggingface': 'ğŸ¤— Hugging Face',
                    'ollama': 'ğŸ¤– Ollama'
                };
                apiNameDisplay = `<span class="api-badge">${apiNames[debugInfo.usedApi] || debugInfo.usedApi}</span>`;
            }
            
            messageDiv.innerHTML = `
                <div class="avatar" aria-hidden="true">${avatarEmoji}</div>
                <div class="content">
                    <div class="message-header">
                        <strong>${senderName}</strong>${apiNameDisplay}
                        <span class="message-time">${new Date().toLocaleTimeString('ja-JP')}</span>
                    </div>
                    <div class="message-content">${message.replace(/\n/g, '<br>')}</div>
                    ${debugInfo && debugInfo.usedApi ? createDebugInfoHTML(debugInfo) : ''}
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®HTMLã‚’ç”Ÿæˆ
        function createDebugInfoHTML(debugInfo) {
            if (!debugInfo || !debugInfo.usedApi) return '';
            
            const apiName = debugInfo.usedApi;
            const apiEmojis = {
                'gemini': 'ğŸ¤–',
                'groq': 'âš¡',
                'openai': 'ğŸ§ ',
                'huggingface': 'ğŸ¤—',
                'ollama': 'ğŸ¤–'
            };
            
            const apiNames = {
                'gemini': 'Google Gemini',
                'groq': 'Groq',
                'openai': 'OpenAI',
                'huggingface': 'Hugging Face',
                'ollama': 'Ollama'
            };
            
            let details = [];
            
            if (apiName === 'gemini' && debugInfo.geminiEnabled !== undefined) {
                details.push(`Geminiæœ‰åŠ¹: ${debugInfo.geminiEnabled ? 'âœ…' : 'âŒ'}`);
                details.push(`APIã‚­ãƒ¼è¨­å®š: ${debugInfo.geminiApiKeySet ? 'âœ…' : 'âŒ'}`);
            }
            
            return `
                <div class="debug-info ${apiName}">
                    <div class="debug-info-title">
                        ${apiEmojis[apiName] || 'ğŸ¤–'} ä½¿ç”¨AI: <strong>${apiNames[apiName] || apiName}</strong>
                    </div>
                    ${details.length > 0 ? `<div class="debug-info-detail">${details.join(' | ')}</div>` : ''}
                </div>
            `;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
        async function sendMessage() {
            console.log('sendMessageé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
            const chatInput = document.getElementById('chatInput');
            const userMessage = chatInput.value.trim();

            console.log('å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', userMessage);

            if (!userMessage) {
                console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã®ãŸã‚é€ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
                return;
            }

            console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºä¸­...');
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessageToChat('user', userMessage);
            chatInput.value = '';

            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
            chatHistory.push({ sender: 'user', message: userMessage });

            // AIã®å¿œç­”ã‚’ç”Ÿæˆï¼ˆPHP APIçµŒç”±ï¼‰
            try {
                console.log('PHP APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...');

                const useOllama = document.getElementById('useOllama').checked;

                // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’APIå½¢å¼ã«å¤‰æ›ï¼ˆç›´è¿‘6ã‚¿ãƒ¼ãƒ³ã¾ã§ï¼‰
                const historyForAPI = chatHistory.slice(-6).map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'assistant',
                    content: msg.message
                }));

                const response = await fetch('api/ai-response.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        history: historyForAPI,
                        useOllama: useOllama
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('PHP API HTTPã‚¨ãƒ©ãƒ¼:', response.status, response.statusText);
                    console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', errorText);
                    throw new Error(`PHP API Error: ${response.status} ${response.statusText}\nãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${errorText.substring(0, 500)}`);
                }

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã—ã¦ã‹ã‚‰JSONè§£æ
                const responseText = await response.text();
                console.log('PHP APIã‹ã‚‰ã®ç”Ÿãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæœ€åˆã®500æ–‡å­—ï¼‰:', responseText.substring(0, 500));
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('PHP APIã‹ã‚‰ã®å¿œç­”ï¼ˆè§£ææˆåŠŸï¼‰:', data);
                } catch (jsonError) {
                    console.error('=== JSONè§£æã‚¨ãƒ©ãƒ¼ ===');
                    console.error('ã‚¨ãƒ©ãƒ¼:', jsonError);
                    console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨æ–‡ï¼‰:', responseText);
                    console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹é•·:', responseText.length);
                    throw new Error(`JSONè§£æã‚¨ãƒ©ãƒ¼: ${jsonError.message}\nãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæœ€åˆã®1000æ–‡å­—ï¼‰: ${responseText.substring(0, 1000)}`);
                }

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
                const usedApi = data.usedApi || data.apiType || 'unknown';
                const apiEmojis = {
                    'gemini': 'ğŸ¤–',
                    'groq': 'âš¡',
                    'openai': 'ğŸ§ ',
                    'huggingface': 'ğŸ¤—',
                    'ollama': 'ğŸ¤–'
                };
                const apiNames = {
                    'gemini': 'Google Gemini',
                    'groq': 'Groq',
                    'openai': 'OpenAI',
                    'huggingface': 'Hugging Face',
                    'ollama': 'Ollama'
                };
                
                console.log('%c=== AI API ä½¿ç”¨çŠ¶æ³ ===', 'font-size: 16px; font-weight: bold; color: #667eea;');
                console.log(`%c${apiEmojis[usedApi] || 'ğŸ¤–'} ä½¿ç”¨ã•ã‚ŒãŸAI: ${apiNames[usedApi] || usedApi}`, 
                    'font-size: 14px; font-weight: bold; color: #4285f4; background: #e8f0fe; padding: 4px 8px; border-radius: 4px;');
                console.log('Geminiæœ‰åŠ¹:', data.debug?.geminiEnabled ? 'âœ…' : 'âŒ');
                console.log('Gemini APIã‚­ãƒ¼è¨­å®š:', data.debug?.geminiApiKeySet ? 'âœ…' : 'âŒ');
                console.log('OpenAIæœ‰åŠ¹:', data.debug?.openaiEnabled ? 'âœ…' : 'âŒ');
                console.log('OpenAI APIã‚­ãƒ¼è¨­å®š:', data.debug?.openaiApiKeySet ? 'âœ…' : 'âŒ');
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªå¯èƒ½ï¼‰
                if (data.debug?.debugLogs && data.debug.debugLogs.length > 0) {
                    console.log('%c=== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰ ===', 'font-size: 14px; font-weight: bold; color: #ff6b6b;');
                    data.debug.debugLogs.forEach((log, index) => {
                        const isError = log.includes('ã‚¨ãƒ©ãƒ¼') || log.includes('å¤±æ•—') || log.includes('HTTP ã‚¨ãƒ©ãƒ¼');
                        const isSuccess = log.includes('æˆåŠŸ');
                        const style = isError 
                            ? 'color: #ff6b6b; font-weight: bold;' 
                            : isSuccess 
                            ? 'color: #51cf66; font-weight: bold;'
                            : 'color: #495057;';
                        console.log(`%c[${index + 1}] ${log}`, style);
                    });
                    console.log('========================');
                }
                
                if (data.debug) {
                    console.log('è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', data.debug);
                }
                console.log('========================');

                if (data && data.response) {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚ˆã‚Šè©³ç´°ãªæƒ…å ±ã‚’è¡¨ç¤º
                    let responseText = data.response;

                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã‚ã‚‹å ´åˆã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°ã‚’è¡¨ç¤º
                    if (data.debug && !data.ollamaUsed && usedApi === 'unknown') {
                        console.warn('âš ï¸ AI APIãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                        console.warn('ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', data.debug);

                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                        if (!data.ollamaAvailable) {
                            responseText += '\n\nğŸ’¡ **ãƒ’ãƒ³ãƒˆ**: AI APIãŒåˆ©ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        } else if (!data.debug.useOllama) {
                            responseText += '\n\nğŸ’¡ **ãƒ’ãƒ³ãƒˆ**: ã€ŒAI APIã‚’ä½¿ç”¨ã™ã‚‹ã€ã«ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        }
                    }

                    // AIã®å¿œç­”ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å«ã‚€ï¼‰
                    addMessageToChat('assistant', responseText, data.debug || { usedApi: usedApi });
                    chatHistory.push({ sender: 'assistant', message: data.response });
                } else {
                    throw new Error('PHP APIã‹ã‚‰ã®å¿œç­”ãŒç„¡åŠ¹ã§ã™');
                }

            } catch (error) {
                console.error('PHP APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                console.log('ã‚¨ãƒ©ãƒ¼ã®è©³ç´°:', error.message);

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”ã‚’å‰Šé™¤ï¼šã‚¨ãƒ©ãƒ¼ã‚’æ˜ç¢ºã«è¡¨ç¤º
                const errorMessage = `âŒ **APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**\n\n` +
                    `**ã‚¨ãƒ©ãƒ¼è©³ç´°**:\n` +
                    `- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${error.message}\n` +
                    `- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: APIæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ\n\n` +
                    `**è€ƒãˆã‚‰ã‚Œã‚‹åŸå› **:\n` +
                    `1. ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒå¤±æ•—ã—ã¦ã„ã‚‹\n` +
                    `2. PHP APIï¼ˆai-response.phpï¼‰ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ãªã„\n` +
                    `3. InfinityFreeã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã«ã‚ˆã‚Šæ¥ç¶šãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§\n\n` +
                    `**ãƒ‡ãƒãƒƒã‚°æ–¹æ³•**:\n` +
                    `- ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n` +
                    `- ã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n` +
                    `- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ãƒ–ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„`;
                
                addMessageToChat('assistant', errorMessage);
                chatHistory.push({ sender: 'assistant', message: errorMessage });
            }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”é–¢æ•°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ
        // AIãŒå®Ÿéš›ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”ã¯ä½¿ç”¨ã—ã¾ã›ã‚“
    </script>
</body>

</html>